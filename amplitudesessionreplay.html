<script type="module">
  import * as sessionReplay from "https://cdn.jsdelivr.net/npm/@amplitude/session-replay-browser/+esm";
  import cookie from "https://cdn.jsdelivr.net/npm/js-cookie/+esm";

  const AMPLITUDE_API_KEY = 'your-amplitude-api-key'; // replace with your real key

  const getStoredSessionId = () => {
    return cookie.get("amp_session_id") || 0;
  };

  // Wait for analytics.js to be fully loaded
  window.analytics.ready(async function () {
    const user = window.analytics.user();
    const storedSessionId = getStoredSessionId();

    await sessionReplay.init(42c16158d0bd7f3be2f8d11f78c9275b, {
      sessionId: storedSessionId,
      deviceId: user.anonymousId()
    }).promise;

    // ✅ Middleware 1: Update session replay when session ID changes
    analytics.addSourceMiddleware(({ payload, next, integrations }) => {
      const storedSessionId = getStoredSessionId();
      const nextSessionId = payload.obj.integrations?.['Actions Amplitude']?.session_id || 0;

      if (storedSessionId < nextSessionId) {
        cookie.set("amp_session_id", nextSessionId);
        sessionReplay.setSessionId(nextSessionId);
      }

      next(payload);
    });

    // ✅ Middleware 2: Inject session replay properties into every track() call
    analytics.addSourceMiddleware(({ payload, next }) => {
      const sessionReplayProperties = sessionReplay.getSessionReplayProperties();

      if (payload.type() === "track") {
        payload.obj.properties = {
          ...payload.obj.properties,
          ...sessionReplayProperties,
        };
      }

      next(payload);
    });
  });
</script>
