<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segment UTM Capture Plugin</title>
</head>
<body>
    <h1>Segment UTM Capture Plugin Example</h1>
    <p>This page demonstrates how to use a Segment plugin to capture UTM parameters and attach them to events.</p>

    <script>
      // Utility functions to get and set cookies
      function setCookie(name, value, days) {
        var expires = "";
        if (days) {
          var date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        console.log(`Set cookie: ${name}=${value}`);
      }

      function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) == ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) == 0) {
            console.log(`Retrieved cookie: ${name}=${c.substring(nameEQ.length, c.length)}`);
            return c.substring(nameEQ.length, c.length);
          }
        }
        console.log(`Cookie not found: ${name}`);
        return null;
      }

      function deleteCookie(name) {
        document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax";
        console.log(`Deleted cookie: ${name}`);
      }

      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      // Capture UTM parameters from URL
      function captureUTMParameters() {
        const utmParams = {
          source: getQueryParam('utm_source'),
          medium: getQueryParam('utm_medium'),
          campaign: getQueryParam('utm_campaign'),
          content: getQueryParam('utm_content'),
          term: getQueryParam('utm_term')
        };
        console.log('UTM parameters captured from URL:', utmParams);

        // Store UTM parameters in cookies
        for (const key in utmParams) {
          if (utmParams[key]) {
            setCookie(`utm_${key}`, utmParams[key], 30); // Store for 30 days
          }
        }

        return utmParams;
      }

      // Retrieve UTM parameters from cookies
      function getUTMFromCookies() {
        const utmParams = {
          source: getCookie('utm_source'),
          medium: getCookie('utm_medium'),
          campaign: getCookie('utm_campaign'),
          content: getCookie('utm_content'),
          term: getCookie('utm_term')
        };
        console.log('UTM parameters retrieved from cookies:', utmParams);
        return utmParams;
      }

      function prepareCampaignObject(utmParams) {
        return {
          source: utmParams.source || null,
          medium: utmParams.medium || null,
          name: utmParams.campaign || null,
          content: utmParams.content || null,
          term: utmParams.term || null
        };
      }

      // Initialize the analytics plugin
      (function() {
        var analytics = window.analytics = window.analytics || [];

        if (!analytics.initialize) {
          if (analytics.invoked) {
            console.error("Segment snippet included twice.");
          } else {
            analytics.invoked = true;
            analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "screen", "once", "off", "on", "addSourceMiddleware", "addIntegrationMiddleware", "setAnonymousId", "addDestinationMiddleware", "register"];
            analytics.factory = function(method) {
              return function() {
                var args = Array.prototype.slice.call(arguments);
                args.unshift(method);
                analytics.push(args);
                return analytics;
              };
            };
            for (var i = 0; i < analytics.methods.length; i++) {
              var key = analytics.methods[i];
              analytics[key] = analytics.factory(key);
            }
            analytics.load = function(key, options) {
              var script = document.createElement("script");
              script.type = "text/javascript";
              script.async = true;
              script.src = "https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";
              var first = document.getElementsByTagName("script")[0];
              first.parentNode.insertBefore(script, first);
              analytics._loadOptions = options;
            };
            analytics.SNIPPET_VERSION = "4.1.0";
            analytics.load("G5BwWiwo7E5XCw85h43neqDn59j6KCTp");
            analytics.page();
          }
        }

        // Capture UTM parameters and set up the plugin
        analytics.ready(function() {
          console.log('Analytics.js is ready');
          const utmParams = captureUTMParameters(); // Capture UTM parameters on page load
          const storedUTMParams = getUTMFromCookies(); // Retrieve stored UTM parameters from cookies

          const campaign = prepareCampaignObject(storedUTMParams);
          console.log('Campaign object prepared:', campaign);

          // Update analytics context with UTM parameters
          analytics.addSourceMiddleware(function(event) {
            event.context = event.context || {};
            event.context.campaign = campaign;
            return event;
          });

          // Test page event
          analytics.page();

          // Set up additional event listeners if needed
          analytics.on('track', function(event, properties, options) {
            console.log('Track event:', event, properties, options);
          });
          analytics.on('identify', function(event, properties, options) {
            console.log('Identify event:', event, properties, options);
          });
          analytics.on('page', function(event, properties, options) {
            console.log('Page event:', event, properties, options);
          });
        });
      })();
    </script>
</body>
</html>
